pipeline {
    agent any
    tools {
        maven 'maven-jenkins-installation-3.9.8'//local
        nodejs "nodejs-jenkins-installation-22.7.0"
    }

    stages {

        stage('Git Checkout') {
            steps {
                checkout scmGit(
                        branches: [[name: '*/master']],
                        extensions: [],
                        userRemoteConfigs: [[url: "https://github.com/ValeriaCalzada/demoRest.git"]]
                        )
                    echo 'Git Checkout Completed'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQServer') {
                    sh '''
                        mvn clean verify sonar:sonar -Dsonar.projectKey=DemoProjectSonarGithub -Dsonar.projectName='DemoProjectSonarGithub' -Dsonar.host.url=http://sonar:9000
                    '''
                    echo 'SonarQube Analysis Completed'
                }
            }
        }

        stage('Token retrieval') {
            steps {
                withCredentials([string(credentialsId: 'client-secret', variable: 'CLIENT_SECRET')]){
                    script{
                        try{
                            env.access_token=sh([script: '''
                                        bodyAuth="grant_type=client_credentials"
                                        responseAuth=$(curl -H "Content-Type: application/x-www-form-urlencoded" -H "Accept-Charset: UTF-8" \
                                                -X POST \
                                                -u "${CLIENT_ID}:${CLIENT_SECRET}" \
                                                -d "$bodyAuth" \
                                                --insecure \
                                                "$TOKEN_URL")
                                        echo "${responseAuth}" > response.json
                                        jq -r ".access_token" response.json
                                        ''', returnStdout: true]).trim()
                        }catch(err){
                            currentBuild.result = 'FAILURE'
                            //def statusMessage = sh(script: 'echo "${listApplication}" | jq -r ".errorMessage"', returnStdout: true).trim()
                            echo "Retrieving token for ${APP_NAME} failed:  ${access_token}"
                        }
                        
                    }
                }
            }
        }

        stage('List All Eligible Applications') {
            steps {
                script{
                    try{
                        env.listApplication=sh([script: '''
                                    curl -H 'dmip-tenant-id: 1' -H "dmip-application-name: ${CLIENT_ID}" \
                                            -X GET \
                                            -H "Authorization: Bearer $access_token" \
                                            --insecure \
                                            "$INSTANCE_DMPS_URL:31443/dmip-gw/dmip/api/application/promotion-eligible?offset=1&limit=15"
                                            ''', returnStdout: true]).trim()
                        def application = env.listApplication.findAll { app ->
                                app.toString().toLowerCase().contains(APP_NAME.toLowerCase())
                        }                    
                        if(application == null){
                            currentBuild.result = 'FAILURE'
                            error("${APP_NAME} was not found as an eligible promotion application")
                        }
                    }catch(err){
                        currentBuild.result = 'FAILURE'
                        //def statusMessage = sh(script: 'echo "${listApplication}" | jq -r ".errorMessage"', returnStdout: true).trim()
                        echo "Listing eligible applications  ${APP_NAME} failed: ${listApplication}"
                    } 
                }
            }
        }

        stage('Export Application') {
            steps {
                script{
                    try{
                        env.exportResponse=sh([script: '''
                                    curl -H 'dmip-tenant-id: 1' -H "dmip-application-name: ${CLIENT_ID}" \
                                            -X POST \
                                            -H "Authorization: Bearer $access_token" -H "Content-Type: application/vnd.fico.dmip.v6.0+json"\
                                            --insecure \
                                            "$INSTANCE_DMPS_URL:31443/dmip-gw/dmip/api/application/export?application-name=$APP_NAME&destination=trusted-resource&adapter-name=$DMPS_TRUSTED_RESOURCE" \
                                            ''', returnStdout: true]).trim()
                        env.appZipUuidTxt=sh([script: '''
                                    echo "${exportResponse}" | tr "\n' ' " | jq -r ".appZipUuidTxt" 
                                    ''', returnStdout: true]).trim()
                    }catch(err){
                        currentBuild.result = 'FAILURE'
                        def statusMessage = sh(script: 'echo "${exportResponse}" | tr "\n' ' " | jq -r ".errorMessage"', returnStdout: true).trim()
                        echo "Exporting ${APP_NAME} failed:  ${statusMessage}"
                    }
                }
            }
        }
        

        stage('Check status on Export process') {
            steps {
                script{
                    try{
                        timeout(time: 2, unit: 'MINUTES'){
                            waitUntil{
                                env.statusCheck= sh([script: '''
                                        curl -H "dmip-tenant-id: 1" -H "dmip-application-name: ${CLIENT_ID}" \
                                                    -X GET \
                                                    -H "Authorization: Bearer $access_token" \
                                                    --insecure \
                                                    "$INSTANCE_DMPS_URL:31443/dmip-gw/dmip/api/application/export/${appZipUuidTxt}/status"
                                                    ''', returnStdout: true]).trim()
                                def appZipStatus = sh(script: 'echo "${statusCheck}" | tr "\n' ' " | jq -r ".appZipStatus"', returnStdout: true).trim()
                                if (appZipStatus == "UPLOADED"){
                                    env.zipFileName=sh(script: '''
                                        statusMessage=$(echo "${statusCheck}" | jq -r ".statusMessage") 
                                        echo "${statusMessage}" | grep -oP "'[^']+\\.zip'" | sed "s/'//g" 
                                        ''', returnStdout: true).trim()
                                    return true
                                }else {
                                    sleep(15)
                                    return false
                                }
                            }
                        } 
                    }catch(err){
                        currentBuild.result = 'FAILURE'
                        def statusMessage = sh(script: 'echo "${statusCheck}" | tr "\n' ' " | jq -r ".statusMessage"', returnStdout: true).trim()
                        echo "Exporting ${APP_NAME} failed:  ${statusMessage}"
                    }
                                       
                }
            }
        }

        stage('Import Application') {
            steps {
                script{
                    try{
                        withCredentials([usernamePassword(credentialsId: 'github-dmps-credentials', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME'), string(credentialsId:'github-dmps-token', variable:'GIT_TOKEN')]){
                        env.importResponse=sh([script: '''
                                    curl -H 'dmip-tenant-id: 2' -H "dmip-application-name: ${CLIENT_ID}" \
                                                -X POST \
                                                -H "Authorization: Bearer $access_token" -H "Content-Type: application/vnd.fico.dmip.v6.0+json"\
                                                -H "git-username: $GIT_USERNAME" -H "git-password: $GIT_TOKEN" \
                                                --insecure \
                                                "$INSTANCE_DMPS_URL:31443/dmip-gw/dmip/api/application/import?application-package-name=${zipFileName}&application-name=${APP_NAME}&source=trusted-resource&adapter-name=$DMPS_TRUSTED_RESOURCE&overwrite-application=$OVERWRITE_APPLCATION&retain-labels=true&auto-job-start=$JOB_AUTOSTART" 
                                                ''', returnStdout: true]).trim()
                        env.appZipUuidTxtImport=sh([script: '''
                                        echo "${importResponse}" | tr "\n' ' " | jq -r ".appZipUuidTxt" 
                                        ''', returnStdout: true]).trim()
                        }
                    }catch(err){
                        currentBuild.result = 'FAILURE'
                        def statusMessage = sh(script: 'echo "${importResponse}" | tr "\n' ' " | jq -r ".errorMessage"', returnStdout: true).trim()
                        echo "Importing ${APP_NAME} failed:  ${statusMessage}"
                    }   
                }
            }
        }

        stage('Check status on Import process') {
            steps {
                script{
                    try{
                        timeout(time: 2, unit: 'MINUTES'){
                            waitUntil{
                                env.statusCheck= sh([script: '''
                                        curl -H 'dmip-tenant-id: 1' -H "dmip-application-name: ${CLIENT_ID}" \
                                                    -X GET \
                                                    -H "Authorization: Bearer $access_token" \
                                                    --insecure \
                                                    "$INSTANCE_DMPS_URL:31443/dmip-gw/dmip/api/application/import/${appZipUuidTxtImport}/status"
                                                    ''', returnStdout: true]).trim()
                                //def appZipStatus = sh(script: '''echo "${statusCheck}" | tr '\n' ' ' |  jq ".appZipStatus"''', returnStdout: true).trim()
                                def statusCode=sh([script: '''
                                        echo "${statusCheck}" | tr '\n' ' ' | jq -r ".statusCode" 
                                        ''', returnStdout: true]).trim()
                                if (statusCode == "200"){  
                                    return true
                                }else {
                                    if(statusCode == "400" || statusCode == "500"){
                                        throw new Exception()
                                    }
                                    sleep(15)
                                    return false
                                }
                            }
                        }
                    }catch(err){
                        currentBuild.result = 'FAILURE'
                        def statusMessage = sh(script: '''
                                echo "${statusCheck}" | tr '\n' ' ' | jq ".statusMessage"
                                ''', returnStdout: true).trim()
                        echo "Importing ${APP_NAME} failed:  ${statusMessage}"
                        return false
                    }
                    
                }
            }
        }
    }
}